---
title: Patrolling Demo
date: 2024-03-18 18:00:00 +0100
tags: [bt studio]     # TAG names should always be lowercase
categories: [demos, actions]
author: javier
img_path: /assets/img/
toc: true
comments: true
pin: true
---

## Installation

Before starting make sure you have installed ROS2 humble in your system and sourced the ros underlay. It is highly recommended to add this line at the end of your .basrhc file.

```bash
source /opt/ros/humble/setup.bash
```

First install the actual demo package found in [here](https://github.com/RoboticsLabURJC/2024-tfg-javier-izquierdo/demo/patrolling_demo.zip) and move it to the workspace:

```bash
mkdir -p demo_ws/src
mv patrolling_demo.zip demo_ws/src
unzip demo_ws/src/patrolling_demo.zip
```

Now install the additional packages needed:

```bash
cd src/patrolling_demo/
git clone --recursive https://github.com/Ar-Ray-code/darknet_ros_fp16.git
git clone https://github.com/IntelligentRoboticsLabs/kobuki.git
git clone https://github.com/SamthinkGit/perception_asr.git

vcs import < kobuki/thirdparty.repos
vcs import < perception_asr/thirdparty.repos
```

As some of the cmakes in this packages are wrong you must change the 2 following ones:

- perception_asr/CMakeLists.txt
```cmake
# find dependencies
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(vision_msgs REQUIRED)
find_package(darknet_ros_msgs REQUIRED)
find_package(image_transport REQUIRED)
find_package(cv_bridge REQUIRED)
find_package(message_filters REQUIRED)
find_package(pcl_conversions REQUIRED)
find_package(pcl_ros REQUIRED)
find_package(image_geometry REQUIRED)
find_package(depth_image_proc REQUIRED)
find_package(Boost 1.45.0 COMPONENTS date_time) # Add this line
``` 
- ThirdParty/openni2_camera/openni2_camera/CMakeLists.txt
```cmake
# find dependencies
find_package(Boost REQUIRED COMPONENTS system thread)
find_package(ament_cmake REQUIRED)
find_package(camera_info_manager REQUIRED)
find_package(image_transport REQUIRED)
find_package(openni2_camera_msgs REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(rclcpp REQUIRED)
find_package(rclcpp_components REQUIRED)
find_package(PCL 1.8 REQUIRED)
find_package(pcl_conversions REQUIRED)
find_package(pcl_ros REQUIRED)
find_package(Boost 1.45.0 COMPONENTS date_time)  # Add this line
``` 

Now the only thing left is init Rosdep and compiling (Note that you need to be in the root if the workspace):
```bash
cd ../.. # If you are already in root DO NOT EXECUTE THIS
sudo rosdep init
rosdep update
colcon build --symlink-install
source install/setup.bash
```

## How to launch

For the moment being, this is not an easy task so please execute each of the following commands in a different terminal, also make sure to always be sourcing the workspace:

```bash
ros2 launch kobuki simulation.launch.py
# Now wait until this is completely launched
ros2 launch kobuki navigation_sim.launch.py
ros2 launch darknet_ros darknet_ros.launch.py
ros2 run perception_asr darknet_detection --ros-args -r input_bbxs_detection:=/darknet_ros/bounding_boxes -r output_detection_2d:=/detection_2d_array
ros2 run perception_asr detection_2d_to_3d_depth --ros-args -r input_depth:=/camera/depth/image_raw -r camera_info:=/camera/depth/camera_info -r input_detection_2d:=/detection_2d_array
```

And for last, launch the demo (if it gets stuck before going to the door for the first time please reset both the simulation and the navigation).
```bash
ros2 run patrolling_demo executor
```


## Showcase

[Patrolling BT](https://github.com/RoboticsLabURJC/2024-tfg-javier-izquierdo/tree/main/docs/assets/img/recepcionist_demo/demo_video.png)

## Why is not in Gazebo Fortress?

As said in the week 2 post, the world model assets that aws world uses are not updated for Fortress, so I would need to create another world.

[Video](https://github.com/RoboticsLabURJC/2024-tfg-javier-izquierdo/tree/main/docs/assets/img/recepcionist_demo/fortress_aws.mp4)
